<Window x:Class="WpfXrayQA.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:WpfXrayQA.ViewModels"
        mc:Ignorable="d"
        Title="WPF QA X-ray App (GD Only)" Height="768" Width="1024">
        <Window.Resources>
            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        </Window.Resources>

    <TabControl>
        <TabItem Header="Main Review">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="250"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="220"/>
                </Grid.ColumnDefinitions>

                <DockPanel Grid.Column="0" Margin="5">
                    <TextBlock DockPanel.Dock="Top" Text="Pending (_1_8.jpg)" FontWeight="Bold" Margin="0,0,0,5"/>
                    <ListBox ItemsSource="{Binding PendingFiles}" SelectedItem="{Binding SelectedFile}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="2">
                                    <TextBlock Text="{Binding FileName}" FontWeight="Bold" Foreground="Blue"/>
                                    <TextBlock Text="{Binding ModelName}" FontSize="10"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>

                <Border Grid.Column="1" BorderBrush="Gray" BorderThickness="1" Margin="5" ClipToBounds="True" Background="#EEE">
                    <ScrollViewer x:Name="ImgScrollViewer" 
                          HorizontalScrollBarVisibility="Hidden" 
                          VerticalScrollBarVisibility="Hidden">

                        <Grid>
                            <Image Source="{Binding CurrentImage}" Stretch="None"
                               MouseWheel="Image_MouseWheel" 
                               MouseDown="Image_MouseDown" 
                               MouseUp="Image_MouseUp" 
                               MouseMove="Image_MouseMove"
                               RenderTransformOrigin="0.5,0.5">
                                <Image.RenderTransform>
                                    <ScaleTransform x:Name="ImgScale" ScaleX="1" ScaleY="1"/>
                                </Image.RenderTransform>
                            </Image>

                            <ItemsControl ItemsSource="{Binding GridOverlayPoints}" IsHitTestVisible="False">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas Background="{x:Null}"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Ellipse Width="6" Height="6" Fill="Red" Margin="-3,-3">
                                            <Ellipse.RenderTransform>
                                                <TranslateTransform X="{Binding X}" Y="{Binding Y}"/>
                                            </Ellipse.RenderTransform>
                                        </Ellipse>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </ScrollViewer>
                </Border>

                <StackPanel Grid.Column="2" Margin="10">
                    <TextBlock Text="Status:" FontWeight="Bold"/>
                    <TextBlock Text="{Binding MessageStatus}" Foreground="Red" TextWrapping="Wrap" Margin="0,0,0,20"/>

                    <Button Content="OK (PASS)" Command="{Binding SubmitOkCommand}" Background="LightGreen" Height="50" FontSize="18" FontWeight="Bold" Margin="0,5"/>

                    <Separator Margin="0,15"/>

                    <TextBlock Text="Defect Type:" FontWeight="Bold"/>
                    <RadioButton Content="Short" IsChecked="{Binding IsShort}" Margin="0,5"/>
                    <RadioButton Content="Missing" IsChecked="{Binding IsMissing}" Margin="0,5"/>
                    <RadioButton Content="Both" IsChecked="{Binding IsBoth}" Margin="0,5"/>

                    <Button Content="NG (FAIL)" Command="{Binding SubmitNgCommand}" Background="#FFAAAA" Height="50" FontSize="18" FontWeight="Bold" Margin="0,10"/>

                    <Button Content="Need Re-run" Command="{Binding SubmitRerunCommand}" Background="LightYellow" Height="30" Margin="0,5"/>

                    <TextBlock Text="Comment:" Margin="0,10,0,0"/>
                    <TextBox Text="{Binding Comment}" Height="60" TextWrapping="Wrap" AcceptsReturn="True"/>
                </StackPanel>
            </Grid>
        </TabItem>
        <TabItem Header="Teach">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="320"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <ScrollViewer Grid.Column="0">
                    <StackPanel Margin="10">
                        <TextBlock Text="AUTO INSPECTION CONFIG" FontSize="18" FontWeight="Bold" Foreground="DarkBlue" HorizontalAlignment="Center"/>
                        <Separator Margin="0,10"/>

                        <Button Content="⚡ SCAN (AUTO DETECT)" 
                        Command="{Binding AutoDetectBallsCommand}" 
                        Height="50" Background="OrangeRed" Foreground="White" FontWeight="Bold" FontSize="16" Margin="0,0,0,15"/>

                        <TextBlock Text="{Binding TeachStatus}" FontWeight="Bold" Foreground="Blue" TextWrapping="Wrap" FontSize="14" Margin="0,0,0,10"/>

                        <GroupBox Header="1. Shape Filter" Margin="0,5">
                            <StackPanel Margin="5">
                                <TextBlock Text="{Binding MinArea, StringFormat='Min Area: {0} px'}"/>
                                <Slider Minimum="300" Maximum="1000" Value="{Binding MinArea}" IsSnapToTickEnabled="True" TickFrequency="10"/>

                                <TextBlock Text="{Binding MaxArea, StringFormat='Max Area: {0} px'}" Margin="0,5,0,0"/>
                                <Slider Minimum="500" Maximum="5000" Value="{Binding MaxArea}" IsSnapToTickEnabled="True" TickFrequency="100"/>

                                <TextBlock Margin="0,5,0,0">
                            <Run Text="Min Circularity: "/>
                            <Run Text="{Binding MinCircularity, StringFormat=N2}"/>
                            <Run Text=" (0.0 = Bắt hết)"/>
                                </TextBlock>
                                <Slider Minimum="0.0" Maximum="1.0" Value="{Binding MinCircularity}" TickFrequency="0.05" IsSnapToTickEnabled="True"/>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="2. Threshold (Độ nhạy)" Margin="0,5">
                            <StackPanel Margin="5">
                                <CheckBox Content="Use Adaptive Threshold (Auto)" IsChecked="{Binding UseAdaptive}" FontWeight="Bold" Margin="0,0,0,5"/>

                                <StackPanel Visibility="{Binding UseAdaptive, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <TextBlock Text="{Binding AdaptiveParamC, StringFormat='Sensitivity (ParamC): {0}'}"/>
                                    <Slider Minimum="1" Maximum="50" Value="{Binding AdaptiveParamC}"/>
                                    <TextBlock Text="(Càng nhỏ càng dễ bắt ball tối)" FontStyle="Italic" FontSize="10" Foreground="Gray"/>
                                </StackPanel>

                                <StackPanel Visibility="{Binding UseAdaptive, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Inverse}">
                                    <TextBlock Text="{Binding FixedThresholdVal, StringFormat='Fixed Threshold: {0}'}" Margin="0,10,0,0"/>
                                    <Slider Minimum="0" Maximum="255" Value="{Binding FixedThresholdVal}"/>
                                    <TextBlock Text="(0=Đen, 255=Trắng. Kéo về khoảng 80-120)" FontStyle="Italic" FontSize="10" Foreground="Gray"/>
                                </StackPanel>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="3. Advanced" Margin="0,5">
                            <StackPanel Margin="5">
                                <TextBlock Text="{Binding MorphKernel, StringFormat='Morph Kernel Size: {0}'}"/>
                                <Slider Minimum="1" Maximum="9" Value="{Binding MorphKernel}" TickFrequency="2" IsSnapToTickEnabled="True"/>
                                <TextBlock Text="(1 = Tắt lọc nhiễu. Tăng lên nếu nhiều nhiễu hạt)" FontStyle="Italic" FontSize="10" Foreground="Gray" TextWrapping="Wrap"/>

                                <Separator Margin="0,10"/>
                                <TextBlock Text="Target Blob Count (Chuẩn):"/>
                                <TextBox Text="{Binding TargetCount}" FontWeight="Bold" TextAlignment="Center"/>
                            </StackPanel>
                        </GroupBox>

                    </StackPanel>
                </ScrollViewer>

                <Border Grid.Column="1" BorderBrush="Gray" BorderThickness="1" Margin="5" Background="Black" ClipToBounds="True">
                    <ScrollViewer x:Name="TeachScrollViewer" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Hidden">
                        <Grid x:Name="ZoomContainer" 
                              Width="{Binding CurrentImage.PixelWidth}"   
                              Height="{Binding CurrentImage.PixelHeight}"
                              MouseWheel="Image_MouseWheel" 
                              MouseDown="Image_MouseDown" 
                              MouseMove="Image_MouseMove" 
                              MouseUp="Image_MouseUp">

                            <Grid.RenderTransform>
                                <ScaleTransform x:Name="TeachImgScale" ScaleX="1" ScaleY="1"/>
                            </Grid.RenderTransform>

                            <Image x:Name="TeachImage" Source="{Binding CurrentImage}" Stretch="None"/>

                            <ItemsControl ItemsSource="{Binding GridOverlayShapes}" IsHitTestVisible="True">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas Background="{x:Null}"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>

                                <ItemsControl.ItemContainerStyle>
                                    <Style TargetType="ContentPresenter">
                                        <Setter Property="Canvas.Left" Value="{Binding Left}"/>
                                        <Setter Property="Canvas.Top" Value="{Binding Top}"/>
                                    </Style>
                                </ItemsControl.ItemContainerStyle>

                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Ellipse Width="{Binding Diameter}" Height="{Binding Diameter}" 
                                             Stroke="Lime" StrokeThickness="1"
                                             Fill="Transparent"
                                             ToolTip="{Binding TooltipInfo}">
                                            <Ellipse.InputBindings>
                                                <MouseBinding Gesture="RightClick" 
                                                  Command="{Binding DataContext.RemoveOverlayCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                  CommandParameter="{Binding}"/>
                                            </Ellipse.InputBindings>
                                        </Ellipse>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </ScrollViewer>
                </Border>
            </Grid>
        </TabItem>
        <TabItem Header="Settings">
            <StackPanel Margin="20">
                <TextBlock Text="Root Paths (Mỗi dòng 1 đường dẫn - VD: X:\)" FontWeight="Bold"/>
                <TextBox Text="{Binding SettingRootPaths}" Height="150" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,5,0,10"/>
                <Button Content="Save Settings" Command="{Binding SaveSettingsCommand}" Width="150" HorizontalAlignment="Left"/>
                
                <TextBlock Text="Hướng dẫn Test:" FontWeight="Bold" Margin="0,20,0,5"/>
                <TextBlock Text="1. Tạo folder: C:\FakeXRayData\20251222\ModelTest\GD\"/>
                <TextBlock Text="2. Copy file ảnh vào và đổi tên thành đuôi _1_8.jpg (VD: 20251222120000_1_8.jpg)"/>
                <TextBlock Text="3. Paste 'C:\FakeXRayData' vào ô trên và bấm Save."/>
            </StackPanel>
        </TabItem>
    </TabControl>
</Window>